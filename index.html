<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Xu·∫•t k·∫øt qu·∫£ thi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h2>Xu·∫•t k·∫øt qu·∫£ thi ra Excel (c√≥ ƒë√°p √°n ƒë√∫ng)</h2>
  <input type="text" id="quizIdInput" placeholder="Nh·∫≠p QuizId, v√≠ d·ª•: toan11_de01"/>
  <button id="exportBtn">T·∫£i file Excel</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // üîß Firebase config c·ªßa b·∫°n
    const firebaseConfig = {
      apiKey: "AIzaSyAwM9_H8PTooz3Nh4MPt9wdtBScIvMC318",
      authDomain: "toanthayha-cd96c.firebaseapp.com",
      projectId: "toanthayha-cd96c",
      storageBucket: "toanthayha-cd96c.firebasestorage.app",
      messagingSenderId: "940207284081",
      appId: "1:940207284081:web:9801158f72cc14053ae0d0",
      measurementId: "G-9D5ZQ66BSB"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // üìå L·∫•y ƒë√°p √°n chu·∫©n theo quizId
    async function getAnswerKey(quizId) {
      const q = query(collection(db, "quizAnswerKeys"), where("quizId", "==", quizId));
      const snapshot = await getDocs(q);
      if (snapshot.empty) return {};
      return snapshot.docs[0].data().answers || {};  // { Q101: "A", Q102: "B", ... }
    }

    // üìå L·∫•y k·∫øt qu·∫£ h·ªçc sinh
    async function getResults(quizId) {
      const q = query(collection(db, "quizResults"), where("quizId", "==", quizId));
      const snapshot = await getDocs(q);
      return snapshot.docs.map(doc => doc.data());
    }

    function autoFitColumns(ws, data) {
      const colWidths = [];
      const header = Object.keys(data[0] || {});
      header.forEach((h, i) => {
        let maxLen = h.length;
        data.forEach(row => {
          const val = row[h] ? String(row[h]) : "";
          if (val.length > maxLen) maxLen = val.length;
        });
        colWidths[i] = { wch: maxLen + 2 };
      });
      ws["!cols"] = colWidths;
    }

    async function exportExcel() {
      const quizId = document.getElementById("quizIdInput").value.trim();
      if (!quizId) {
        alert("Vui l√≤ng nh·∫≠p QuizId");
        return;
      }

      const [answerKey, results] = await Promise.all([
        getAnswerKey(quizId),
        getResults(quizId)
      ]);

      if (results.length === 0) {
        alert("Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o cho QuizId n√†y!");
        return;
      }

      const rows = [];

      results.forEach(r => {
        // Th√¥ng tin chung
        rows.push({
          "SBD": r.studentId || "",
          "H·ªç v√† t√™n": r.fullname || "",
          "L·ªõp": r.className || "",
          "ƒêi·ªÉm": r.score ?? "",
          "Ng√†y n·ªôp": r.submittedAt?.toDate?.().toLocaleString("vi-VN") || ""
        });

        // Chi ti·∫øt t·ª´ng c√¢u
        const answers = r.answers || {};
        Object.keys(answers).forEach(qid => {
          rows.push({
            "SBD": r.studentId || "",
            "C√¢u h·ªèi ID": qid,
            "B·∫°n ch·ªçn": answers[qid],
            "ƒê√°p √°n ƒë√∫ng": answerKey[qid] || "N/A"
          });
        });

        // D√≤ng tr·ªëng ph√¢n c√°ch
        rows.push({});
      });

      const ws = XLSX.utils.json_to_sheet(rows);
      autoFitColumns(ws, rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "KetQua");

      XLSX.writeFile(wb, `KetQua_${quizId}.xlsx`);
    }

    document.getElementById("exportBtn").addEventListener("click", exportExcel);
  </script>
</body>
</html>
