<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Xu·∫•t Excel</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <button onclick="exportExcel()">Xu·∫•t Excel</button>

  <script>
    // üîπ C·∫•u h√¨nh Firebase c·ªßa b·∫°n
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function fetchRows() {
      const snapshot = await db.collection("KetQua").get();
      let rows = [];
      snapshot.forEach(doc => {
        const d = doc.data();
        rows.push({
          "M√£ b√†i": d.examCode || "",
	  	  "QuizId": d.quizId || "",
          "SBD": d.studentId || d.id || "",
          "H·ªç v√† t√™n": d.fullname || "",
          "L·ªõp": d.className || d.class || "",
          "Tr∆∞·ªùng": d.school || "",
          "ƒêi·ªÉm": typeof d.score === "number" ? d.score : "",
          "Th·ªùi gian l√†m(gi√¢y)": typeof d.timeTaken === "number" ? d.timeTaken : "",
          "Ng√†y n·ªôp": submittedAt,
         "Chi ti·∫øt c√¢u tr·∫£ l·ªùi": formatAnswers(d.answers || {})
        });
      });
      return rows;
    }

    // üîπ H√†m format l·∫°i object answers cho d·ªÖ ƒë·ªçc
    function formatAnswers(answers) {
      if (!answers || typeof answers !== "object") return "";

      let details = [];
      let i = 1;

      Object.keys(answers).forEach((key) => {
        const ans = answers[key];

        // Tr∆∞·ªùng h·ª£p d·∫°ng m·∫£ng [true,false,true,false]
        if (Array.isArray(ans)) {
          details.push(`C√¢u ${i}: [${ans.map(v => v ? "‚úì" : "‚úó").join(", ")}]`);
        }
        // Tr∆∞·ªùng h·ª£p l√† string (v√≠ d·ª• "$x=3$")
        else if (typeof ans === "string") {
          details.push(`C√¢u ${i}: ${ans}`);
        }
        // Tr∆∞·ªùng h·ª£p kh√°c (null, s·ªë, object l·ªìng)
        else if (ans == null) {
          details.push(`C√¢u ${i}: (kh√¥ng tr·∫£ l·ªùi)`);
        }
        else {
          details.push(`C√¢u ${i}: ${JSON.stringify(ans)}`);
        }

        i++;
      });

      return details.join("\n"); // xu·ªëng d√≤ng trong Excel
    }

    async function exportExcel() {
      const rows = await fetchRows();
      const worksheet = XLSX.utils.json_to_sheet(rows);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "K·∫øt qu·∫£");
      XLSX.writeFile(workbook, "KetQua_toanthayha.xlsx");
    }
  </script>
</body>
</html>      
      
    	 
